name: CD - Deploy to Kubernetes

on:
  workflow_run:
    # ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö 'name:' ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå CI
    workflows: ["Backend CI/CD", "Frontend CI/CD"] 
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-to-k8s:
    # ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ CI (Backend ‡∏´‡∏£‡∏∑‡∏≠ Frontend) ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    # ‡πÉ‡∏ä‡πâ Runner ‡∏Ç‡∏≠‡∏á GitHub
    runs-on: ubuntu-latest

    steps:
      - name: üì• Set up Kubeconfig
        # ‡πÉ‡∏ä‡πâ Action ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏£‡∏π‡∏õ (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏á‡∏ß‡∏•‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ä‡∏∑‡πà‡∏≠ Azure)
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          # ‡∏î‡∏∂‡∏á‡∏Å‡∏∏‡∏ç‡πÅ‡∏à K8s ‡∏à‡∏≤‡∏Å Secret
          kubeconfig: ${{ secrets.KUBE_CONFIG_DATA }} 

      - name: üöÄ Trigger Rolling Update
        run: |
          echo "Restarting deployments to pull the 'latest' image..."
          # ‡∏™‡∏±‡πà‡∏á K8s ‡πÉ‡∏´‡πâ‡∏î‡∏∂‡∏á Image 'latest' ‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡∏°‡πà
          kubectl rollout restart deployment backend-deployment -n dormitory-app
          kubectl rollout restart deployment frontend-deployment -n dormitory-app
          
          echo "Waiting for deployments to complete..."
          kubectl rollout status deployment backend-deployment -n dormitory-app --timeout=60s
          kubectl rollout status deployment frontend-deployment -n dormitory-app --timeout=60s
          
          echo "‚úÖ Deployment successful!"