name: CD - Deploy to Kubernetes (Self-Hosted)

on:
  workflow_run:
    workflows: ["Backend CI/CD", "Frontend CI/CD"] 
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-to-k8s:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: [self-hosted, Linux, X64] 

    steps:
      - name: üöÄ Trigger Rolling Update
        run: |
          echo "Restarting deployments to pull the 'latest' image..."

          # Runner ‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ‡∏°‡∏µ kubectl ‡πÅ‡∏•‡∏∞ kubeconfig ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß
          kubectl rollout restart deployment backend-deployment -n dormitory-app
          kubectl rollout restart deployment frontend-deployment -n dormitory-app

          echo "Waiting for deployments to complete..."
          kubectl rollout status deployment backend-deployment -n dormitory-app --timeout=600s
          kubectl rollout status deployment frontend-deployment -n dormitory-app --timeout=600s

          echo "‚úÖ Deployment successful!"