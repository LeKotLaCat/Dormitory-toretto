name: CD - Deploy to Kubernetes

on:
  workflow_run:
    # ชื่อต้องตรงกับ 'name:' ในไฟล์ CI
    workflows: ["Backend CI/CD", "Frontend CI/CD"] 
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-to-k8s:
    # ทำงานเมื่อ CI (Backend หรือ Frontend) ทำงานสำเร็จ
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    # ใช้ Runner ของ GitHub
    runs-on: ubuntu-latest

    steps:
      - name: Set up Kubeconfig
        # ใช้ Action สำเร็จรูป (ไม่ต้องกังวลเรื่องชื่อ Azure)
        uses: azure/k8s-set-context@v4
        with:
          method: kubeconfig
          # ดึงกุญแจ K8s จาก Secret
          kubeconfig: ${{ secrets.KUBE_CONFIG_DATA }} 

      - name: Trigger Rolling Update
        run: |
          echo "Restarting deployments to pull the 'latest' image..."
          # สั่ง K8s ให้ดึง Image 'latest' ตัวใหม่
          kubectl rollout restart deployment backend-deployment -n dormitory-app
          kubectl rollout restart deployment frontend-deployment -n dormitory-app
          
          echo "Waiting for deployments to complete..."
          kubectl rollout status deployment backend-deployment -n dormitory-app --timeout=60s
          kubectl rollout status deployment frontend-deployment -n dormitory-app --timeout=60s
          
          echo "Deployment successful!"
