name: CD - Deploy to Kubernetes (Self-Hosted)

on:
  workflow_run:
    workflows: ["Backend CI/CD", "Frontend CI/CD"] 
    types: [completed]
    branches: [main]
  workflow_dispatch:

jobs:
  deploy-to-k8s:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: [self-hosted, Linux, X64] 

    steps:
      # เราไม่จำเป็นต้องใช้ 'azure/k8s-set-context'
      # เพราะ Runner จะใช้ 'kubeconfig' ที่ติดตั้งถาวรบนเครื่อง
      # ($HOME/.kube/config) โดยอัตโนมัติ

      - name:  Trigger Rolling Update
        run: |
          echo "Restarting deployments to pull the 'latest' image..."
          
          # คำสั่งนี้จะทำงานได้ทันที
          kubectl rollout restart deployment backend-deployment -n dormitory-app
          kubectl rollout restart deployment frontend-deployment -n dormitory-app
          
          echo "Waiting for deployments to complete..."
          kubectl rollout status deployment backend-deployment -n dormitory-app --timeout=60s
          kubectl rollout status deployment frontend-deployment -n dormitory-app --timeout=60s
          
          echo " Deployment successful!"